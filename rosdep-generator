#!/usr/bin/env python

import argparse
import os
import urllib2
import yaml

parser = argparse.ArgumentParser(description="Generate rosdep key mapping so that bloom can resolve dependencies for an overlaid rosdistro.")
parser.add_argument("--org", default="ros", help="Github org from which to fetch rosdistro.")
parser.add_argument("--repo", default="rosdistro", help="Github repo from which to fetch rosdistro.")
parser.add_argument("--distro", default="indigo", help="Distro to generate for.")
parser.add_argument("--distribution-file", default="", help="Override for the full url to a 'distribution.yaml' file. If not given, the URL is guessed from org, repo and rosdistro.")
parser.add_argument("--output", "-O", default="", help="Override for the output file name. If not given, it `{org}-{repo}-{distro}.yaml` is used.")
args = parser.parse_args()

if args.distribution_file:
    url = args.distribution_file
else:
    url = "https://github.com/%s/%s/raw/master/%s/distribution.yaml" % \
        (args.org, args.repo, args.distro)

print "Downloading: %s" % url
response = urllib2.urlopen(url)
response_text = response.read()
print "Parsing %d bytes of yaml." % len(response_text)
distribution = yaml.load(response_text)

print "Extracting package names."
platforms = distribution['release_platforms'].keys()
packages = set()
for name, meta in distribution['repositories'].iteritems():
    if 'release' in meta:
        if 'packages' in meta['release']:
            packages.update(meta['release']['packages'])
        else:
            packages.add(name)

output_yaml = {}
print "Assembling output yaml structure."
for package in packages:
    output_yaml[package] = {}
    for platform in platforms:
        output_yaml[package][platform] = "ros-%s-%s" % (args.distro, package.replace("_", "-"))

if args.output:
    output_file = args.output
else:
    output_file = "%s-%s-%s.yaml" % (args.org, args.repo, args.distro)
print "Outputting: %s" % output_file
with open(output_file, "w") as f:
    yaml.dump(output_yaml, f)

print "Complete. Suggested next steps:"
print
print '  sudo sh -c \'echo "yaml file://%s/%s %s" > /etc/ros/rosdep/sources.list.d/90-%s.list\'' % \
        (os.getcwd(), output_file, args.distro, output_file.replace('.yaml', ''))
print '  rosdep update'
print
